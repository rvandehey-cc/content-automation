#!/bin/sh

# Post-commit Hook - Story 6.3: Post-commit Hook for Commit Tracking
#
# Purpose: Track commit events in BMM workflow status for automation visibility.
# This hook runs after every successful commit and logs the commit event.
#
# Graceful Failure: Uses || true to ensure git operations complete even if
# status tracking fails (NFR9: Graceful Degradation)

# Extract commit message from the most recent commit (AC: 4)
commit_message=$(git log -1 --pretty=%B)

# GUARD: Prevent infinite loop
# If the commit was generated by this hook, exit immediately
if echo "$commit_message" | grep -q "chore(automation): update workflow status"; then
  exit 0
fi

# Log commit event to BMM workflow status (AC: 5, 7)
# Pass "commit_made" event with commit message metadata
# Use || true to prevent commit failures if status update fails (AC: 6)
node .husky/scripts/update-workflow-status.js "commit_made" "$commit_message" || true

# AUTO-COMMIT: Keep the repo clean (Fix for infinite modified state)
# If the status file was modified, commit it immediately
if git diff --name-only | grep -q "_bmad-output/bmm-workflow-status.yaml"; then
  git add _bmad-output/bmm-workflow-status.yaml
  # Use --no-verify to skip hooks (prevent loop) and [skip ci] to save resources
  git commit -m "chore(automation): update workflow status [skip ci]" --no-verify
fi
