#!/bin/sh


current_branch=$(git rev-parse --abbrev-ref HEAD)

if [ "$current_branch" = "main" ] || [ "$current_branch" = "dev" ]; then
  echo "ğŸ›¡ï¸ Pushing to protected branch '$current_branch' - running validations..."
  
  echo "ğŸ§ª Running tests with coverage..."
  if ! npm run test:coverage; then
    echo "âŒ Tests failed. Push blocked."
    exit 1
  fi
  
  echo "ğŸ§¹ Running linting..."
  if ! npm run lint; then
    echo "âŒ Linting failed. Push blocked."
    exit 1
  fi

  echo "ğŸ§¹ Running web linting..."
  if ! npm run lint:web; then
    echo "âŒ Web linting failed. Push blocked."
    exit 1
  fi

  echo "ğŸ“š Validating documentation synchronization..."
  if ! DOCS_SUPPRESS_HEADER=1 DOCS_BASE_REF="origin/$current_branch" node .husky/scripts/validate-docs.js; then
    echo "âŒ Documentation validation failed. Push blocked."
    exit 1
  fi

  echo "âœ… All pre-push checks passed!"

  # Track successful push validation in workflow status (Story 6.4)
  node .husky/scripts/update-workflow-status.js pre_push_validated "{\"branch\":\"$current_branch\"}" || true
fi
